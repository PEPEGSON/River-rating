<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>River Rating</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="preload" as="image" href="./assets/bg.png">
  <link rel="preload" as="image" href="./assets/logo.png">
  <link rel="preload" as="image" href="./assets/champion.png">

  <link rel="preload" as="image" href="./assets/rank1.png">
  <link rel="preload" as="image" href="./assets/rank2.png">
  <link rel="preload" as="image" href="./assets/rank3.png">
  <link rel="preload" as="image" href="./assets/rank4.png">
  <link rel="preload" as="image" href="./assets/rank5.png">
  <link rel="preload" as="image" href="./assets/rank6.png">
  <link rel="preload" as="image" href="./assets/rank7.png">
  <link rel="preload" as="image" href="./assets/t9.png">

  <style>
    :root{
      --bg:#0b0c0f;
      --panel:rgba(18,20,26,.62);
      --panel2:rgba(18,20,26,.78);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.90);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.42);
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --shadow2:0 10px 30px rgba(0,0,0,.45);
      --radius:18px;

      --rowA: rgba(255,255,255,.060);
      --rowB: rgba(255,255,255,.035);
      --glass: rgba(12, 13, 17, .35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:url("./assets/bg.png") center/cover no-repeat;
      filter:saturate(1.05) contrast(1.05);
      transform:scale(1.03);
      z-index:-3;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 520px at 50% 25%, rgba(214,181,106,.22), transparent 62%),
        radial-gradient(900px 520px at 20% 90%, rgba(0,0,0,.55), transparent 60%),
        linear-gradient(to bottom, rgba(0,0,0,.70), rgba(0,0,0,.82));
      z-index:-2;
    }

    .wrap{width:min(1200px,94vw);margin:22px auto 40px}

    .topbar{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      gap:14px;
      padding:14px 16px;
      border-radius:var(--radius);
      background:linear-gradient(to bottom, rgba(18,20,26,.62), rgba(18,20,26,.40));
      border:1px solid var(--stroke);
      box-shadow:var(--shadow2);
      backdrop-filter:blur(10px);
    }
    .brand{display:flex;align-items:center;justify-content:flex-start;min-width:240px}
    .brand img{
      height:44px;width:auto;display:block;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.55));
    }
    .center-title{text-align:center;line-height:1}
    .center-title .title{
      font-family:Cinzel,serif;
      font-weight:700;
      letter-spacing:.10em;
      font-size:22px;
      text-transform:uppercase;
      color:rgba(255,255,255,.94);
      text-shadow:0 18px 40px rgba(0,0,0,.6);
      white-space:nowrap;
    }
    .season-name{
      font-family:Cinzel,serif;
      font-weight:600;
      letter-spacing:.02em;
      font-size:14px;
      color:rgba(240,222,154,.92);
      text-align:right;
      justify-self:end;
      max-width:520px;
    }

    .controls{
      margin-top:14px;
      padding:12px 16px;
      border-radius:var(--radius);
      background:var(--panel);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow2);
      backdrop-filter:blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .left-controls,.right-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .label{font-size:12px;color:var(--muted);letter-spacing:.02em}
    .status{font-size:12px;color:var(--muted2);margin-left:8px}

    .btn{
      appearance:none;
      border:1px solid rgba(214,181,106,.42);
      background:linear-gradient(to bottom, rgba(240,222,154,.18), rgba(214,181,106,.08));
      color:rgba(255,255,255,.88);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      box-shadow:0 8px 18px rgba(0,0,0,.35);
      font-weight:600;
      letter-spacing:.01em;
    }
    .btn:hover{
      transform:translateY(-1px);
      border-color:rgba(240,222,154,.65);
      background:linear-gradient(to bottom, rgba(240,222,154,.24), rgba(214,181,106,.12));
      box-shadow:0 12px 26px rgba(0,0,0,.45);
    }

    select{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10, 11, 14, .55);
      color:rgba(255,255,255,.90);
      padding:9px 38px 9px 12px;
      border-radius:12px;
      outline:none;
      cursor:pointer;
      backdrop-filter:blur(10px);
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      max-width:78vw;
    }
    .select-wrap{position:relative;display:inline-flex;align-items:center;gap:10px}
    .select-wrap::after{
      content:"‚ñæ";
      position:absolute;
      right:12px;
      pointer-events:none;
      color:rgba(240,222,154,.90);
      font-size:14px;
      transform:translateY(1px);
    }

    .panel{
      margin-top:14px;
      border-radius:var(--radius);
      background:var(--panel2);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      overflow:hidden;
    }
    .panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(to right, rgba(214,181,106,.08), transparent 55%);
    }
    .panel-title{
      font-family:Cinzel,serif;
      font-weight:700;
      letter-spacing:.05em;
      text-transform:uppercase;
      font-size:13px;
      color:rgba(255,255,255,.88);
    }

    .lb{
      padding:12px 12px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .lb-row{
      position:relative;
      display:grid;
      grid-template-columns: 68px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px 12px;
      border-radius:18px;

      background: var(--glass);
      border:1px solid rgba(214,181,106,.18);
      box-shadow:0 14px 34px rgba(0,0,0,.40);

      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      overflow:hidden;
      cursor:pointer;
    }

    .lb-row:nth-child(odd)::before,
    .lb-row:nth-child(even)::before{
      content:"";
      position:absolute;
      inset:0;
      z-index:0;
    }
    .lb-row:nth-child(odd)::before{ background: var(--rowA); }
    .lb-row:nth-child(even)::before{ background: var(--rowB); }

    .lb-row::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to right, rgba(0,0,0,.40), rgba(0,0,0,.10), rgba(0,0,0,.40));
      z-index:0;
      pointer-events:none;
    }
    .lb-row > *{ position:relative; z-index:1; }

    .place{
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:Cinzel,serif;
      font-weight:800;
      font-size:22px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.28);
      margin-left:2px;
    }
    .place.p1{ color:rgba(255,226,120,.98); border-color:rgba(255,226,120,.55); box-shadow:0 0 14px rgba(255,210,90,.18); }
    .place.p2{ color:rgba(220,226,235,.98); border-color:rgba(220,226,235,.55); box-shadow:0 0 14px rgba(220,226,235,.12); }
    .place.p3{ color:rgba(205,127,50,.98); border-color:rgba(205,127,50,.55); box-shadow:0 0 14px rgba(205,127,50,.12); }

    .namebox{display:flex;flex-direction:column;gap:6px;min-width:0}
    .name-top{display:flex;align-items:center;gap:10px;min-width:0}
    .rank-mini{
      width:40px;height:40px;object-fit:contain;
      filter:drop-shadow(0 12px 18px rgba(0,0,0,.55));
      flex:0 0 auto;
    }
    .nm{
      font-family:Cinzel,serif;
      font-weight:700;
      font-size:22px;
      color:rgba(255,255,255,.95);
      text-shadow:0 14px 34px rgba(0,0,0,.55);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;
      flex:1 1 auto;
    }

    /* t9 —Å–ø—Ä–∞–≤–∞ –æ—Ç –∏–º–µ–Ω–∏ */
    .t9-mini{
      width:32px;height:32px;object-fit:contain;
      filter:drop-shadow(0 12px 18px rgba(0,0,0,.55));
      opacity:.98;
      flex:0 0 auto;
    }

    /* ‚úÖ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Ç–∞–º –∂–µ, –≥–¥–µ —â–∏—Ç (–±–µ–∑ —Å–¥–≤–∏–≥–∞ –≤–ø—Ä–∞–≤–æ) */
    .ach-mini{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      margin-left:0;
    }
    .ach-mini img{
      width:24px;height:24px;object-fit:contain;
      filter:drop-shadow(0 10px 14px rgba(0,0,0,.55));
      opacity:.95;
    }

    .scores{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
      flex-wrap:nowrap;
    }
    .score-pill{
      border:1px solid rgba(214,181,106,.28);
      border-radius:14px;
      background:rgba(0,0,0,.20);
      padding:9px 10px;
      min-width:86px;
      text-align:center;
      box-shadow:0 12px 24px rgba(0,0,0,.32) inset;
      white-space:nowrap;
    }
    .score-pill .lbl{font-size:10px;color:rgba(255,255,255,.55);letter-spacing:.06em;text-transform:uppercase}
    .score-pill .val{margin-top:4px;font-size:20px;font-weight:800;color:rgba(255,255,255,.92)}

    /* ‚úÖ content-visibility —Ç–æ–ª—å–∫–æ –¥–ª—è –ü–ö (—á—Ç–æ–±—ã –Ω–∞ –º–æ–±–∏–ª–µ –Ω–µ –±—ã–ª–æ ‚Äú–ø–æ–ª–æ—Å–æ–∫‚Äù) */
    @media (min-width: 761px){
      .lb-row{
        content-visibility:auto;
        contain-intrinsic-size: 92px 340px;
      }
    }

    /* ====== –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø + –°–ö–†–û–õ–õ –¢–û–õ–¨–ö–û –°–ü–ò–°–ö–ê ====== */
    @media (max-width: 760px){
      body{ overflow:hidden; }

      .wrap{
        width:min(1200px,94vw);
        height:100dvh;
        margin:0 auto;
        padding:14px 0 14px;
        display:flex;
        flex-direction:column;
        gap:12px;
      }

      .topbar{display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center}
      .brand{min-width:0;justify-content:center}
      .brand img{height:42px}
      .season-name{text-align:center;max-width:92vw}
      .center-title .title{font-size:18px;letter-spacing:.08em}

      .controls{ margin-top:0; }

      .panel{
        margin-top:0;
        flex:1 1 auto;
        display:flex;
        flex-direction:column;
        overflow:hidden;
      }
      .panel-head{ flex:0 0 auto; }

      .lb{
        flex:1 1 auto;
        overflow:auto;
        -webkit-overflow-scrolling:touch;
        padding:10px 10px 14px;
        gap:10px;
      }

      /* —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∫ –±—ã–ª–∞, –±–µ–∑ —Å–∂–∞—Ç–∏—è */
      .lb-row{
        grid-template-columns: 54px 1fr auto;
        gap:8px;
        padding:10px 10px;
        border-radius:16px;
      }

      .place{width:42px;height:42px;font-size:16px}

      .rank-mini{width:28px;height:28px}
      .nm{font-size:17px}

      .t9-mini{width:26px;height:26px}

      /* –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–µ –≤ —Å—Ç–æ–ª–±–∏–∫: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
      .ach-mini{
        margin-left:0;
        gap:5px;
        flex-wrap:nowrap;
        overflow-x:auto;
        overflow-y:hidden;
        -webkit-overflow-scrolling:touch;
        padding-bottom:2px;
      }
      .ach-mini img{width:18px;height:18px}

      .ach-mini::-webkit-scrollbar{height:0}
      .ach-mini{scrollbar-width:none}

      .scores{gap:6px}
      .score-pill{
        min-width:68px;
        padding:7px 8px;
        border-radius:12px;
      }
      .score-pill .lbl{font-size:9px}
      .score-pill .val{font-size:16px}
    }

    /* ====== Modal (–∫–∞–∫ –±—ã–ª–æ) ====== */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.70);backdrop-filter:blur(6px);z-index:50}
    .card{
      width:min(560px,92vw);
      margin:5vh auto;
      border-radius:18px;
      background:rgba(16,18,24,.88);
      border:1px solid rgba(214,181,106,.55);
      box-shadow:0 30px 90px rgba(0,0,0,.72);
      overflow:hidden;
      max-height:90vh;
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;
      background:linear-gradient(to right, rgba(214,181,106,.14), rgba(0,0,0,0));
      border-bottom:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .modal-title{font-family:Cinzel,serif;font-weight:700;letter-spacing:.05em;text-transform:uppercase;font-size:14px;color:rgba(240,222,154,.95)}
    .close{border:1px solid rgba(214,181,106,.7);background:rgba(0,0,0,.30);color:rgba(255,255,255,.86);border-radius:12px;padding:8px 10px;cursor:pointer}
    .modal-body{
      padding:16px;
      overflow:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
      position:relative;
    }
    .modal-body.champion::before{
      content:"";
      position:absolute;inset:0;
      background:url("./assets/champion.png") center/cover no-repeat;
      filter:blur(6px) brightness(.55);
      opacity:.9;
      z-index:0;
    }
    .modal-body > *{ position:relative; z-index:1; }

    .pc-top{text-align:center;padding:18px 10px 8px;border-bottom:1px solid rgba(214,181,106,.35)}
    .rank-icon{width:110px;height:110px;object-fit:contain;display:block;margin:0 auto 10px;filter:drop-shadow(0 14px 26px rgba(0,0,0,.6))}
    .rank-title{font-family:Cinzel,serif;letter-spacing:.12em;font-weight:700;font-size:14px;color:rgba(240,222,154,.90);text-transform:uppercase;margin-bottom:6px}
    .player-name{font-family:Cinzel,serif;font-weight:700;font-size:40px;letter-spacing:.02em;color:rgba(255,255,255,.95);text-shadow:0 18px 45px rgba(0,0,0,.55);margin-bottom:10px}

    .section-title{
      display:flex;align-items:center;justify-content:center;gap:10px;
      font-family:Cinzel,serif;letter-spacing:.10em;font-weight:700;text-transform:uppercase;
      color:rgba(240,222,154,.90);margin:16px 0 10px;font-size:14px;
    }

    .medals{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px;width:100%}
    .pill{
      border:1px solid rgba(214,181,106,.35);
      border-radius:14px;
      background:rgba(0,0,0,.25);
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      box-shadow:0 12px 26px rgba(0,0,0,.35) inset;
      min-width:0;
    }
    .pill .left{display:flex;align-items:center;gap:8px;font-weight:700;color:rgba(255,255,255,.9);min-width:0}
    .pill .left span{white-space:nowrap}
    .pill .num{font-weight:800;color:rgba(255,255,255,.92);white-space:nowrap}

    .ach-wrap{border:1px solid rgba(214,181,106,.25);border-radius:16px;background:rgba(0,0,0,.20);padding:14px;max-width:100%;overflow:hidden}
    .ach-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;justify-items:center;align-items:center;width:100%;max-width:100%}
    .ach-item{width:108px;height:108px;border-radius:18px;border:1px solid rgba(214,181,106,.25);background:rgba(0,0,0,.22);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;max-width:100%}
    .ach-item img{width:78%;height:78%;object-fit:contain;filter:drop-shadow(0 12px 18px rgba(0,0,0,.55))}
    .ach-t9{grid-column:1/span 3;width:100%;max-width:100%;height:170px;border-radius:20px;border:1px solid rgba(214,181,106,.45);background:rgba(0,0,0,.22);display:flex;align-items:center;justify-content:center;box-shadow:0 0 28px rgba(214,181,106,.18);cursor:pointer;overflow:hidden}
    .ach-t9 img{width:140px;height:140px;object-fit:contain}

    @media (max-width: 420px){
      .pill{padding:9px 10px;gap:6px}
      .pill .left{gap:6px;font-size:12px}
      .pill .num{font-size:14px}
      .ach-item{width:92px;height:92px;border-radius:16px}
      .ach-t9{height:150px;border-radius:18px}
      .ach-t9 img{width:120px;height:120px}
      .ach-grid{gap:10px}
    }

    .history-wrap{border:1px solid rgba(214,181,106,.25);border-radius:16px;background:rgba(0,0,0,.16);padding:12px}
    .history-scroll{max-height:44vh;overflow:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:14px;padding-right:6px}
    .season-block-title{font-family:Cinzel,serif;letter-spacing:.08em;font-weight:800;text-transform:uppercase;color:rgba(240,222,154,.92);font-size:13px;text-align:center;margin:6px 0 2px}
    .hist{display:flex;flex-direction:column;gap:10px}
    .hist-card{border:1px solid rgba(214,181,106,.22);border-radius:14px;background:rgba(0,0,0,.18);padding:10px 12px;display:grid;grid-template-columns:86px 1fr auto;align-items:center;gap:10px;max-width:100%}
    .hist-date{font-weight:800;font-size:18px;color:rgba(255,255,255,.94)}
    .hist-game{color:rgba(240,222,154,.90);font-weight:800;text-align:center}
    .chips{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .chip{border:1px solid rgba(214,181,106,.25);background:rgba(0,0,0,.22);border-radius:999px;padding:6px 10px;font-size:12px;color:rgba(255,255,255,.88);white-space:nowrap;max-width:100%}

    .hint{color:rgba(255,255,255,.45);font-size:12px;margin-top:12px;text-align:center}

    .viewer{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:80;padding:18px;align-items:center;justify-content:center}
    .viewer.open{display:flex}
    .viewer img{max-width:92vw;max-height:92vh;object-fit:contain;border-radius:18px;border:1px solid rgba(214,181,106,.45);box-shadow:0 30px 90px rgba(0,0,0,.75);background:rgba(0,0,0,.20)}
    .viewer .x{position:absolute;top:16px;right:16px;width:44px;height:44px;border-radius:14px;border:1px solid rgba(214,181,106,.65);background:rgba(0,0,0,.35);color:rgba(255,255,255,.88);cursor:pointer;font-size:18px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><img src="./assets/logo.png" alt="River Poker Club"></div>
      <div class="center-title"><div class="title">RIVER RATING</div></div>
      <div class="season-name" id="seasonName">‚Äî</div>
    </div>

    <div class="controls">
      <div class="left-controls">
        <button class="btn" id="prevSeasonBtn" type="button">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–µ–∑–æ–Ω</button>
        <button class="btn" id="nextSeasonBtn" type="button">–°–ª–µ–¥—É—é—â–∏–π —Å–µ–∑–æ–Ω ‚Üí</button>
        <span class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
      </div>

      <div class="right-controls">
        <span class="label">–°–µ–∑–æ–Ω</span>
        <div class="select-wrap">
          <select id="seasonSelect"></select>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div class="panel-title">–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</div>
      </div>
      <div class="lb" id="leaderboard"></div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="card">
      <div class="modal-head">
        <div class="modal-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞</div>
        <button class="close" id="closeBtn">‚úï</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div id="profile">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶</div>
        <div class="hint">–ö–ª–∏–∫ –≤–Ω–µ –æ–∫–Ω–∞ ‚Äî –∑–∞–∫—Ä—ã—Ç—å</div>
      </div>
    </div>
  </div>

  <div class="viewer" id="viewer">
    <button class="x" id="viewerClose">‚úï</button>
    <img id="viewerImg" alt="achievement">
  </div>

<script>
  const API_BASE = "https://script.google.com/macros/s/AKfycbwKd6_brG1Pgy3U3AUX_cNCUoznk2nYzIOYKo790MDs48ktJwlKvdQ_P8TNXqvPJsGkTQ/exec";

  const statusEl     = document.getElementById("status");
  const seasonSelect = document.getElementById("seasonSelect");
  const prevBtn      = document.getElementById("prevSeasonBtn");
  const nextBtn      = document.getElementById("nextSeasonBtn");
  const seasonNameEl = document.getElementById("seasonName");
  const lbEl         = document.getElementById("leaderboard");

  const modalEl   = document.getElementById("modal");
  const modalBody = document.getElementById("modalBody");
  const profileEl = document.getElementById("profile");
  const closeBtn  = document.getElementById("closeBtn");

  const viewer = document.getElementById("viewer");
  const viewerImg = document.getElementById("viewerImg");
  const viewerClose = document.getElementById("viewerClose");

  viewerClose.onclick = () => viewer.classList.remove("open");
  viewer.onclick = (e) => { if (e.target === viewer) viewer.classList.remove("open"); };

  closeBtn.onclick = () => modalEl.style.display = "none";
  modalEl.onclick = (e) => { if (e.target === modalEl) modalEl.style.display = "none"; };

  function setStatus(t){ statusEl.textContent = t; }
  function norm(x){ return String(x ?? "").trim(); }
  function up(x){ return norm(x).toUpperCase(); }

  function toNum(v){
    const s = String(v ?? "").trim().replace(/\s+/g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function clampRankLevel(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return 1;
    const i = Math.round(n);
    return Math.min(7, Math.max(1, i));
  }

  async function apiMeta(){
    const res = await fetch(`${API_BASE}?mode=meta`);
    return await res.json();
  }
  async function apiDashboard(seasonId){
    const res = await fetch(`${API_BASE}?mode=dashboard&season_id=${encodeURIComponent(seasonId)}`);
    return await res.json();
  }
  async function apiProfile(playerId, seasonId){
    const res = await fetch(`${API_BASE}?player_id=${encodeURIComponent(playerId)}&season_id=${encodeURIComponent(seasonId)}`);
    return await res.json();
  }

  let seasonsCache = [];

  function updateSeasonName(){
    const id = up(seasonSelect.value);
    if (id === "TOTAL") { seasonNameEl.textContent = "–û–±—â–∏–π –∑–∞—á—ë—Ç (Total)"; return; }
    const s = seasonsCache.find(x => up(x.season_id) === id);
    seasonNameEl.textContent = s ? s.season_name : "‚Äî";
  }

  function placeClass(n){
    if (n === 1) return "p1";
    if (n === 2) return "p2";
    if (n === 3) return "p3";
    return "";
  }

  function splitAchievements(list){
    const items = (list || []).map(x => String(x).trim()).filter(Boolean);
    const hasT9 = items.includes("t9");
    const rest = items.filter(x => x !== "t9");
    return { hasT9, rest };
  }

  function miniAchievementsHtml(listWithoutT9){
    const items = (listWithoutT9 || []).map(x => String(x).trim()).filter(Boolean).slice(0, 30);
    if (!items.length) return "";
    return `<div class="ach-mini">` + items.map(t => `<img loading="lazy" decoding="async" src="./assets/${t}.png" alt="${t}">`).join("") + `</div>`;
  }

  async function renderLeaderboard(){
    setStatus("–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶");
    const seasonId = up(seasonSelect.value);

    const dash = await apiDashboard(seasonId);
    const rowsRaw = dash.leaderboard || [];

    const rows = [...rowsRaw].sort((a,b) => {
      const keyA = (seasonId === "TOTAL") ? toNum(a.all_seasons_score) : toNum(a.season_score);
      const keyB = (seasonId === "TOTAL") ? toNum(b.all_seasons_score) : toNum(b.season_score);
      if (keyB !== keyA) return keyB - keyA;
      return String(a.name ?? "").localeCompare(String(b.name ?? ""), "ru", {sensitivity:"base"});
    });

    lbEl.innerHTML = rows.map((r, idx) => {
      const place = idx + 1;
      const rankLevel = clampRankLevel(r.rank_level || 1);

      const achListRaw = r.achievements_list || (String(r.achievements || "").split(",").map(s=>s.trim()).filter(Boolean));
      const { hasT9, rest } = splitAchievements(achListRaw);

      const seasonScore = toNum(r.season_score);
      const totalScore  = toNum(r.all_seasons_score);

      const t9Html = hasT9
        ? `<img class="t9-mini" decoding="async" loading="eager" src="./assets/t9.png" alt="t9">`
        : ``;

      return `
        <div class="lb-row" data-player="${r.player_id}">
          <div class="place ${placeClass(place)}">${place}</div>

          <div class="namebox">
            <div class="name-top">
              <img class="rank-mini" decoding="async" loading="eager" src="./assets/rank${rankLevel}.png" alt="rank${rankLevel}">
              <div class="nm">${r.name ?? ""}</div>
              ${t9Html}
            </div>
            ${miniAchievementsHtml(rest)}
          </div>

          <div class="scores">
            <div class="score-pill">
              <div class="lbl">Season</div>
              <div class="val">${seasonScore}</div>
            </div>
            <div class="score-pill">
              <div class="lbl">Total</div>
              <div class="val">${totalScore}</div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    [...lbEl.querySelectorAll("[data-player]")].forEach(el => {
      el.onclick = () => openProfile(el.getAttribute("data-player"));
    });

    setStatus("");
  }

  function medalIcon(kind){
    if (kind === 'top1') return "ü•á";
    if (kind === 'top2') return "ü•à";
    return "ü•â";
  }

  function openViewer(src){
    viewerImg.src = src;
    viewer.classList.add("open");
  }

  function buildAchievementsHtml(list){
    const items = (list || []).map(x => String(x).trim()).filter(Boolean);
    if (!items.length) return `<div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>`;

    const hasT9 = items.includes("t9");
    const rest = items.filter(x => x !== "t9");

    let html = `<div class="ach-wrap"><div class="ach-grid">`;

    if (hasT9){
      html += `<div class="ach-t9" data-ach="t9"><img decoding="async" loading="eager" src="./assets/t9.png" alt="t9"></div>`;
    }

    const r = [...rest];
    if (r.length % 3 === 2){
      r.splice(r.length - 1, 0, "__spacer__");
    }

    for (const t of r){
      if (t === "__spacer__"){
        html += `<div style="width:92px;height:92px;"></div>`;
        continue;
      }
      html += `<div class="ach-item" data-ach="${t}"><img decoding="async" loading="lazy" src="./assets/${t}.png" alt="${t}"></div>`;
    }

    html += `</div></div>`;
    return html;
  }

  function buildHistoryHtml(history){
    const blocks = (history || []);
    if (!blocks.length) return `<div class="hint">–ù–µ—Ç –∏–≥—Ä</div>`;

    const parts = blocks.map(b => {
      const games = (b.games || []);
      const rows = games.map(g => `
        <div class="hist-card">
          <div class="hist-date">${g.date || "‚Äî"}</div>
          <div class="hist-game">${g.game_name || "‚Äî"}</div>
          <div class="chips">
            <div class="chip">–º–µ—Å—Ç–æ: ${g.place ?? "‚Äî"}</div>
            <div class="chip">–æ—á–∫–∏: ${g.points ?? "‚Äî"}</div>
          </div>
        </div>
      `).join("");

      return `
        <div>
          <div class="season-block-title">–°–µ–∑–æ–Ω ¬´${b.season}¬ª</div>
          <div class="hist">${rows || `<div class="hint">–ù–µ—Ç –∏–≥—Ä</div>`}</div>
        </div>
      `;
    }).join("");

    return `<div class="history-wrap"><div class="history-scroll">${parts}</div></div>`;
  }

  async function openProfile(playerId){
    modalEl.style.display = "block";
    profileEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶";
    modalBody.classList.remove("champion");

    const seasonId = up(seasonSelect.value);
    const data = await apiProfile(playerId, seasonId);

    const medals = data.medals || { top1:0, top2:0, top3:0 };
    const rank = data.rank || { level:1, title:"–ù–æ–≤–∏—á–æ–∫" };
    const ach = data.achievements || [];
    if (ach.includes("t9")) modalBody.classList.add("champion");

    const rankIcon = `./assets/rank${clampRankLevel(rank.level)}.png`;
    const nameFromProfile = (data.profile || []).find(x => String(x.label || '').toLowerCase().includes("–∏–º—è"))?.value || "";

    const medalsHtml = `
      <div class="medals">
        <div class="pill"><div class="left"><span>${medalIcon('top1')}</span><span>Top-1</span></div><div class="num">${medals.top1 ?? 0}</div></div>
        <div class="pill"><div class="left"><span>${medalIcon('top2')}</span><span>Top-2</span></div><div class="num">${medals.top2 ?? 0}</div></div>
        <div class="pill"><div class="left"><span>${medalIcon('top3')}</span><span>Top-3</span></div><div class="num">${medals.top3 ?? 0}</div></div>
      </div>
    `;

    profileEl.innerHTML = `
      <div class="pc-top">
        <img class="rank-icon" decoding="async" loading="eager" src="${rankIcon}" alt="rank${rank.level}">
        <div class="rank-title">${rank.title}</div>
        <div class="player-name">${nameFromProfile}</div>
      </div>

      <div class="section-title">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
      ${medalsHtml}

      <div class="section-title">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</div>
      ${buildAchievementsHtml(ach)}

      <div class="section-title">üóÇ –ò–°–¢–û–†–ò–Ø –ò–ì–†</div>
      ${buildHistoryHtml(data.history || [])}
    `;

    profileEl.querySelectorAll("[data-ach]").forEach(el => {
      el.onclick = () => openViewer(`./assets/${el.getAttribute("data-ach")}.png`);
    });
  }

  function preloadImages(urls){
    urls.forEach((url) => {
      const img = new Image();
      img.decoding = "async";
      img.src = url;
    });
  }
  function warmupAssets(){
    preloadImages([
      "./assets/rank1.png","./assets/rank2.png","./assets/rank3.png",
      "./assets/t9.png","./assets/logo.png"
    ]);
    const idle = window.requestIdleCallback || ((fn) => setTimeout(fn, 400));
    idle(() => preloadImages([
      "./assets/rank4.png","./assets/rank5.png","./assets/rank6.png","./assets/rank7.png",
      "./assets/t1.png","./assets/t2.png","./assets/t3.png","./assets/t4.png",
      "./assets/t5.png","./assets/t6.png","./assets/t7.png","./assets/t8.png"
    ]));
  }

  async function init(){
    try{
      warmupAssets();

      setStatus("–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶");
      const meta = await apiMeta();
      seasonsCache = meta.seasons || [];

      seasonSelect.innerHTML =
        `<option value="TOTAL">Total</option>` +
        seasonsCache.map(s => `<option value="${up(s.season_id)}">${s.season_name}</option>`).join("");

      const currentSeason = up(meta.current_season_id || "");
      const exists = seasonsCache.some(s => up(s.season_id) === currentSeason);
      if (currentSeason && exists) seasonSelect.value = currentSeason;
      else if (seasonsCache.length) seasonSelect.value = up(seasonsCache[seasonsCache.length - 1].season_id);
      else seasonSelect.value = "TOTAL";

      updateSeasonName();
      await renderLeaderboard();

      seasonSelect.onchange = async () => {
        setStatus("–ü–µ—Ä–µ–∫–ª—é—á–∞—é —Å–µ–∑–æ–Ω‚Ä¶");
        updateSeasonName();
        await renderLeaderboard();
      };

      prevBtn.onclick = async () => {
        const current = up(seasonSelect.value);
        if (current === "TOTAL"){
          if (!seasonsCache.length) return;
          seasonSelect.value = up(seasonsCache[seasonsCache.length - 1].season_id);
        } else {
          const idx = seasonsCache.findIndex(s => up(s.season_id) === current);
          if (idx > 0) seasonSelect.value = up(seasonsCache[idx - 1].season_id);
        }
        updateSeasonName();
        await renderLeaderboard();
      };

      nextBtn.onclick = async () => {
        const current = up(seasonSelect.value);
        if (current === "TOTAL"){
          if (!seasonsCache.length) return;
          seasonSelect.value = up(seasonsCache[0].season_id);
        } else {
          const idx = seasonsCache.findIndex(s => up(s.season_id) === current);
          if (idx >= 0 && idx < seasonsCache.length - 1) seasonSelect.value = up(seasonsCache[idx + 1].season_id);
        }
        updateSeasonName();
        await renderLeaderboard();
      };

      setStatus("");
    } catch(err){
      console.error(err);
      setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å Web App –∏ –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ.");
    }
  }

  init();
</script>
</body>
</html>
